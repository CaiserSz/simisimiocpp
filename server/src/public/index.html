<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”Œ EV Station Simulator Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .station-card {
            transition: all 0.3s ease;
            border-left: 4px solid #28a745;
        }
        
        .station-card.offline {
            border-left-color: #dc3545;
        }
        
        .station-card.charging {
            border-left-color: #ffc107;
        }
        
        .metrics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .status-online {
            color: #28a745;
        }
        
        .status-offline {
            color: #dc3545;
        }
        
        .status-charging {
            color: #ffc107;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .connection-status {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
        }
        
        .loading-spinner {
            display: none;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="bi bi-lightning-charge"></i>
                EV Station Simulator
            </span>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-success" id="connection-status">
                    <i class="bi bi-wifi"></i> Connected
                </span>
                <div class="d-flex align-items-center gap-2" id="auth-controls">
                    <span class="badge bg-light text-dark d-none" id="user-badge">
                        <i class="bi bi-person-circle"></i>
                        <span id="user-name">Guest</span>
                    </span>
                    <button class="btn btn-outline-light btn-sm" id="login-btn">
                        <i class="bi bi-box-arrow-in-right"></i> Login
                    </button>
                    <button class="btn btn-outline-light btn-sm d-none" id="logout-btn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
                <button class="btn btn-outline-light btn-sm" id="refresh-btn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <!-- Connection Status Alert -->
    <div class="connection-status">
        <div class="alert alert-danger alert-dismissible fade" id="connection-alert" role="alert">
            <i class="bi bi-exclamation-triangle"></i> Connection lost. Trying to reconnect...
            <div class="loading-spinner spinner-border spinner-border-sm ms-2" role="status"></div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="alert alert-warning d-none" id="permission-alert" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Dashboard eriÅŸimi iÃ§in giriÅŸ yapmanÄ±z gerekiyor.
        </div>
        <!-- System Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-broadcast fs-1"></i>
                        <h4 class="mt-2" id="total-stations">0</h4>
                        <p class="mb-0">Total Stations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle fs-1"></i>
                        <h4 class="mt-2" id="online-stations">0</h4>
                        <p class="mb-0">Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-battery-charging fs-1"></i>
                        <h4 class="mt-2" id="charging-sessions">0</h4>
                        <p class="mb-0">Active Sessions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning fs-1"></i>
                        <h4 class="mt-2" id="total-power">0 kW</h4>
                        <p class="mb-0">Total Power</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-plus-circle"></i> Quick Station Control</h5>
                    </div>
                    <div class="card-body">
                        <form id="station-form" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Station ID</label>
                                <input type="text" class="form-control" id="station-id" placeholder="STATION_001" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">OCPP Version</label>
                                <select class="form-select" id="ocpp-version">
                                    <option value="1.6J">OCPP 1.6J</option>
                                    <option value="2.0.1" selected>OCPP 2.0.1</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Vendor</label>
                                <input type="text" class="form-control" id="vendor" value="SimVendor" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Max Power (kW)</label>
                                <input type="number" class="form-control" id="max-power" value="22" min="1" max="350">
                            </div>
                            <div class="col-12">
                                <label class="form-label">CSMS URL</label>
                                <input type="text" class="form-control" id="csms-url" value="ws://localhost:9221" placeholder="ws://localhost:9221" required>
                                <small class="form-text text-muted">WebSocket URL of the CSMS (Central Station Management System)</small>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-play-circle"></i> Create & Start Station
                                </button>
                                <button type="button" class="btn btn-success ms-2" onclick="startAllStations()">
                                    <i class="bi bi-play-fill"></i> Start All
                                </button>
                                <button type="button" class="btn btn-warning ms-2" onclick="stopAllStations()">
                                    <i class="bi bi-stop-fill"></i> Stop All
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-bar-chart"></i> Real-time Metrics</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="metrics-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stations Grid -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-grid"></i> Station Management</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadStations()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="row" id="stations-grid">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading stations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>

    <!-- Login Modal -->
    <div class="modal fade" id="login-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        Dashboard GiriÅŸi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="login-form" class="needs-validation" novalidate>
                    <div class="modal-body">
                        <div class="alert alert-danger d-none" id="login-error"></div>
                        <div class="mb-3">
                            <label for="login-email" class="form-label">E-posta</label>
                            <input type="email" class="form-control" id="login-email" name="email" required autocomplete="username">
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Åžifre</label>
                            <input type="password" class="form-control" id="login-password" name="password" required autocomplete="current-password">
                        </div>
                        <div class="form-text">
                            VarsayÄ±lan kimlik bilgileri iÃ§in <code>/api/auth/info</code> endpoint'ine gÃ¶z atabilirsiniz.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" id="login-spinner" role="status" aria-hidden="true"></span>
                            <span class="ms-2">GiriÅŸ Yap</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import DashboardUtils from '/dashboard/js/dashboard-utils.js';
        import DashboardApi from '/dashboard/js/api-client.js';
        class EVSimulatorDashboard {
            constructor() {
                this.ws = null;
                this.chart = null;
                this.stations = new Map();
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.apiMaxRetries = DashboardApi.DEFAULT_MAX_RETRIES;

                this.authEnabled = false;
                this.authenticated = false;
                this.currentUser = null;
                this.authToken = null;

                this.loginModalElement = document.getElementById('login-modal');
                this.loginModal = this.loginModalElement ? new bootstrap.Modal(this.loginModalElement, { backdrop: 'static' }) : null;
                this.loginForm = document.getElementById('login-form');
                this.loginButton = document.getElementById('login-btn');
                this.logoutButton = document.getElementById('logout-btn');
                this.loginError = document.getElementById('login-error');
                this.loginSpinner = document.getElementById('login-spinner');
                this.userBadge = document.getElementById('user-badge');
                this.userName = document.getElementById('user-name');
                this.permissionAlert = document.getElementById('permission-alert');
                this.stationForm = document.getElementById('station-form');
                this.csrfToken = null;
                this.ensureCsrfToken();

                this.bootstrap();
            }

            async bootstrap() {
                this.initializeChart();
                this.setupEventListeners();
                await this.checkSession();
                this.updateAuthUI();
                this.setStationFormState(this.canManageSimulator());
                this.togglePermissionAlert();

                if (this.authEnabled && !this.authenticated) {
                    this.requireLogin('Dashboard eriÅŸimi iÃ§in giriÅŸ yapmanÄ±z gerekiyor.');
                    return;
                }

                await this.afterAuthentication();
            }

            async afterAuthentication() {
                this.setStationFormState(this.canManageSimulator());
                this.togglePermissionAlert();
                this.initializeWebSocket();
                await this.loadStations();
            }

            async checkSession() {
                try {
                    const response = await fetch('/api/auth/session', { credentials: 'include' });
                    if (!response.ok) {
                        throw new Error(`Session status ${response.status}`);
                    }

                    const data = await response.json();
                    this.authEnabled = Boolean(data.authEnabled);
                    this.authenticated = Boolean(data.authenticated);
                    this.currentUser = data.user || null;

                    if (this.authEnabled && this.authenticated) {
                        this.authToken = window.localStorage.getItem('evsim_auth_token') || null;
                    } else {
                        this.authToken = null;
                        window.localStorage.removeItem('evsim_auth_token');
                    }
                } catch (error) {
                    console.warn('Session kontrolÃ¼ baÅŸarÄ±sÄ±z:', error);
                    this.authEnabled = true;
                    this.authenticated = false;
                    this.currentUser = null;
                    this.authToken = null;
                }
            }
            getCookieValue(name) {
                const cookie = document.cookie.split('; ').find((row) => row.startsWith(`${name}=`));
                return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
            }

            async ensureCsrfToken(force = false) {
                if (!force) {
                    const cookieToken = this.getCookieValue('XSRF-TOKEN');
                    if (cookieToken) {
                        this.csrfToken = cookieToken;
                        return this.csrfToken;
                    }
                }

                try {
                    const response = await fetch('/api/csrf-token', {
                        credentials: 'include',
                        headers: { 'Cache-Control': 'no-cache' },
                    });
                    if (!response.ok) {
                        throw new Error(`CSRF token request failed (${response.status})`);
                    }
                    const data = await response.json().catch(() => ({}));
                    this.csrfToken = data?.csrfToken || this.getCookieValue('XSRF-TOKEN');
                } catch (error) {
                    console.warn('CSRF token alÄ±namadÄ±:', error);
                }

                return this.csrfToken;
            }

            setupEventListeners() {
                if (this.loginButton && this.loginModal) {
                    this.loginButton.addEventListener('click', () => {
                        this.clearLoginFeedback();
                        this.loginModal.show();
                        document.getElementById('login-email')?.focus();
                    });
                }

                if (this.logoutButton) {
                    this.logoutButton.addEventListener('click', () => this.logout());
                }

                if (this.loginForm) {
                    this.loginForm.addEventListener('submit', (event) => {
                        event.preventDefault();
                        const email = event.target.email.value.trim();
                        const password = event.target.password.value;
                        this.performLogin(email, password);
                    });
                }

                if (this.stationForm) {
                    this.stationForm.addEventListener('submit', (event) => {
                        event.preventDefault();
                        if (!this.canManageSimulator()) {
                            this.showToast('Yetki', 'Ä°stasyon oluÅŸturmak iÃ§in operatÃ¶r veya admin rolÃ¼ gerekir.', 'warning');
                            return;
                        }

                        const maxPowerKw = parseFloat(document.getElementById('max-power').value) || 0;
                        const formData = {
                            stationId: document.getElementById('station-id').value.trim(),
                            vendor: document.getElementById('vendor').value.trim(),
                            model: 'SimulatorModel',
                            ocppVersion: document.getElementById('ocpp-version').value,
                            maxPower: Math.max(1, Math.round(maxPowerKw * 1000)),
                            connectorCount: 2,
                            csmsUrl: document.getElementById('csms-url').value.trim(),
                            autoStart: true
                        };

                        this.createStation(formData);
                    });
                }

                const refreshButton = document.getElementById('refresh-btn');
                if (refreshButton) {
                    refreshButton.addEventListener('click', () => this.loadStations());
                }
            }

            clearLoginFeedback() {
                if (this.loginError) {
                    this.loginError.classList.add('d-none');
                    this.loginError.textContent = '';
                }
                if (this.loginSpinner) {
                    this.loginSpinner.classList.add('d-none');
                }
            }

            showLoginError(message) {
                if (this.loginError) {
                    this.loginError.textContent = message;
                    this.loginError.classList.remove('d-none');
                } else {
                    this.showToast('GiriÅŸ HatasÄ±', message, 'danger');
                }
            }

            async performLogin(email, password) {
                if (!email || !password) {
                    this.showLoginError('E-posta ve ÅŸifre zorunludur.');
                    return;
                }

                const submitButton = this.loginForm?.querySelector('button[type="submit"]');
                submitButton?.setAttribute('disabled', 'disabled');
                this.loginSpinner?.classList.remove('d-none');
                this.clearLoginFeedback();

                try {
                    const csrfToken = await this.ensureCsrfToken();
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(csrfToken ? { 'X-XSRF-TOKEN': csrfToken } : {}),
                        },
                        body: JSON.stringify({ email, password })
                    });

                    let data = null;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.warn('Login response parse error:', parseError);
                    }

                    if (!response.ok || !data?.success) {
                        const errorMessage =
                            data?.error?.message ||
                            (typeof data?.error === 'string' ? data.error : null) ||
                            data?.message ||
                            `GiriÅŸ baÅŸarÄ±sÄ±z (HTTP ${response.status}).`;
                        throw new Error(errorMessage);
                    }

                    this.authenticated = true;
                    this.currentUser = data.user;
                    this.authToken = data.token || null;

                    if (this.authToken) {
                        window.localStorage.setItem('evsim_auth_token', this.authToken);
                    }

                    this.updateAuthUI();
                    this.setStationFormState(this.canManageSimulator());
                    this.togglePermissionAlert();

                    this.loginModal?.hide();
                    this.showToast('GiriÅŸ', 'BaÅŸarÄ±yla giriÅŸ yapÄ±ldÄ±.', 'success');

                    await this.ensureCsrfToken(true);
                    await this.afterAuthentication();
                } catch (error) {
                    console.error('Login error:', error);
                    this.showLoginError(error.message || 'GiriÅŸ yapÄ±lamadÄ±.');
                } finally {
                    submitButton?.removeAttribute('disabled');
                    this.loginSpinner?.classList.add('d-none');
                    this.loginForm?.reset();
                }
            }

            async logout() {
                try {
                    await fetch('/api/auth/logout', { credentials: 'include' });
                } catch (error) {
                    console.warn('Logout request failed:', error);
                }

                this.handleUnauthorized('Oturum kapatÄ±ldÄ±.');
            }

            requireLogin(message) {
                this.togglePermissionAlert(message);
                this.setStationFormState(false);
                if (this.loginModal) {
                    this.clearLoginFeedback();
                    this.loginModal.show();
                }
            }

            updateAuthUI() {
                if (!this.authEnabled) {
                    this.userName && (this.userName.textContent = 'Demo Modu (Kimlik doÄŸrulama kapalÄ±)');
                    this.userBadge?.classList.remove('d-none');
                    this.loginButton?.classList.add('d-none');
                    this.logoutButton?.classList.add('d-none');
                    return;
                }

                if (this.authenticated && this.currentUser) {
                    const label = `${this.currentUser.username || this.currentUser.email || 'KullanÄ±cÄ±'} (${this.currentUser.role})`;
                    if (this.userName) {
                        this.userName.textContent = label;
                    }
                    this.userBadge?.classList.remove('d-none');
                    this.loginButton?.classList.add('d-none');
                    this.logoutButton?.classList.remove('d-none');
                } else {
                    this.userBadge?.classList.add('d-none');
                    this.loginButton?.classList.remove('d-none');
                    this.logoutButton?.classList.add('d-none');
                }
            }

            togglePermissionAlert(message) {
                if (!this.permissionAlert) {
                    return;
                }

                let alertMessage = '';

                if (!this.authEnabled) {
                    this.permissionAlert.classList.add('d-none');
                    return;
                }

                if (message) {
                    alertMessage = message;
                } else if (!this.authenticated) {
                    alertMessage = 'Dashboard eriÅŸimi iÃ§in giriÅŸ yapmanÄ±z gerekiyor.';
                } else if (!this.canManageSimulator()) {
                    alertMessage = 'OperatÃ¶r veya admin rolÃ¼ne sahip olmadÄ±ÄŸÄ±nÄ±z iÃ§in istasyon kontrolÃ¼ devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±.';
                }

                if (alertMessage) {
                    this.permissionAlert.textContent = alertMessage;
                    this.permissionAlert.classList.remove('d-none');
                } else {
                    this.permissionAlert.classList.add('d-none');
                }
            }

            setStationFormState(enabled) {
                if (!this.stationForm) {
                    return;
                }

                Array.from(this.stationForm.elements).forEach((element) => {
                    element.disabled = !enabled;
                });

                this.stationForm.classList.toggle('opacity-50', !enabled);
            }

            canManageSimulator() {
                return DashboardUtils.canManageSimulator(
                    this.authEnabled,
                    this.authenticated,
                    this.currentUser?.role
                );
            }

            initializeWebSocket() {
                if (this.ws) {
                    this.ws.disconnect();
                    this.ws = null;
                }

                if (this.authEnabled && !this.authenticated) {
                    return;
                }

                const socketOptions = {
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    reconnectionAttempts: this.maxReconnectAttempts,
                    transports: ['websocket', 'polling']
                };

                if (this.authEnabled && this.authToken) {
                    socketOptions.auth = { token: this.authToken };
                }

                this.ws = io(socketOptions);

                this.ws.on('connect', () => {
                    this.updateConnectionStatus(true);
                    this.reconnectAttempts = 0;
                    this.ws.emit('subscribe:simulation', {});
                });

                this.ws.on('disconnect', () => {
                    this.updateConnectionStatus(false);
                });

                this.ws.on('connect_error', (error) => {
                    console.error('Socket connection error:', error);
                    this.updateConnectionStatus(false);
                });

                this.ws.on('error', (error) => {
                    console.error('Socket error:', error);
                    this.showToast('BaÄŸlantÄ±', 'GerÃ§ek zamanlÄ± baÄŸlantÄ± kurulamadÄ±.', 'warning');
                });

                this.ws.on('simulation:update', (data) => {
                    this.handleWebSocketMessage({ type: 'system_stats', stats: data });
                });

                this.ws.on('station:update', (data) => {
                    this.handleWebSocketMessage({ type: 'station_update', station: data });
                });
            }

            updateConnectionStatus(connected) {
                const statusBadge = document.getElementById('connection-status');
                const connectionAlert = document.getElementById('connection-alert');
                const spinner = connectionAlert?.querySelector('.loading-spinner');

                if (connected) {
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-success';
                        statusBadge.innerHTML = '<i class="bi bi-wifi"></i> Connected';
                    }
                    connectionAlert?.classList.remove('show');
                    spinner && (spinner.style.display = 'none');
                } else {
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-danger';
                        statusBadge.innerHTML = '<i class="bi bi-wifi-off"></i> Disconnected';
                    }
                    connectionAlert?.classList.add('show');
                    spinner && (spinner.style.display = 'inline-block');
                }
            }

            handleWebSocketMessage(payload) {
                if (!payload) {
                    return;
                }

                switch (payload.type) {
                    case 'station_update':
                        this.updateStation(payload.station);
                        break;
                    case 'metrics_update':
                        this.updateMetrics(payload.metrics);
                        break;
                    case 'system_stats':
                        this.updateSystemStats(payload.stats);
                        break;
                    default:
                        console.debug('Bilinmeyen WebSocket mesajÄ±:', payload);
                }
            }

            updateStation(station) {
                if (!station || !station.stationId) {
                    return;
                }

                this.stations.set(station.stationId, station);
                this.renderStations(Array.from(this.stations.values()));
            }

            updateMetrics(metrics) {
                if (!metrics) {
                    return;
                }

                const totalPower = Number(metrics.totalPower ?? metrics.power ?? 0);
                const activeSessions = Number(metrics.activeSessions ?? metrics.sessions ?? 0);
                const chartPower = DashboardUtils.normalizePower(totalPower);

                const totalPowerLabel = DashboardUtils.formatPower(totalPower);
                document.getElementById('total-power').textContent = totalPowerLabel;
                document.getElementById('charging-sessions').textContent = activeSessions;

                if (this.chart) {
                    this.updateChart(chartPower, activeSessions);
                }
            }

            updateSystemStats(stats) {
                if (!stats) {
                    return;
                }

                document.getElementById('total-stations').textContent = stats.totalStations ?? stats.stationCount ?? '0';
                document.getElementById('online-stations').textContent = stats.activeStations ?? stats.onlineStations ?? '0';

                const activeSessions = stats.activeSessions ?? stats.sessions ?? 0;
                document.getElementById('charging-sessions').textContent = activeSessions;

                if (stats.totalPower !== undefined) {
                    document.getElementById('total-power').textContent = DashboardUtils.formatPower(stats.totalPower);
                }
            }

            initializeChart() {
                const canvas = document.getElementById('metrics-chart');
                if (!canvas) {
                    return;
                }

                const ctx = canvas.getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Total Power (kW)',
                                data: [],
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.1
                            },
                            {
                                label: 'Active Sessions',
                                data: [],
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { type: 'linear', display: true, position: 'left' },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            updateChart(power, sessions) {
                if (!this.chart) {
                    return;
                }

                const now = new Date().toLocaleTimeString();
                if (this.chart.data.labels.length > 20) {
                    this.chart.data.labels.shift();
                    this.chart.data.datasets[0].data.shift();
                    this.chart.data.datasets[1].data.shift();
                }

                this.chart.data.labels.push(now);
                this.chart.data.datasets[0].data.push(power);
                this.chart.data.datasets[1].data.push(sessions);
                this.chart.update('none');
            }

            async loadStations() {
                if (this.authEnabled && !this.authenticated) {
                    return;
                }

                try {
                    const response = await this.apiFetch('/api/simulator/stations');
                    const data = await response.json();

                    let stations = [];
                    if (Array.isArray(data)) {
                        stations = data;
                    } else if (Array.isArray(data.data)) {
                        stations = data.data;
                    } else if (data.data && typeof data.data === 'object') {
                        stations = Object.values(data.data);
                    }

                    this.stations = new Map(stations.map((station) => [station.stationId, station]));
                    this.renderStations(stations);
                } catch (error) {
                    if (error.message === 'Unauthorized' || error.message === 'Forbidden') {
                        return;
                    }
                    console.error('Ä°stasyonlar yÃ¼klenirken hata:', error);
                    this.renderStations([]);
                    this.showToast('Hata', 'Ä°stasyonlar yÃ¼klenemedi.', 'danger');
                }
            }

            renderStations(stations) {
                const grid = document.getElementById('stations-grid');
                if (!grid) {
                    return;
                }

                if (!Array.isArray(stations) || stations.length === 0) {
                    grid.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-broadcast" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="mt-3 text-muted mb-0">HenÃ¼z istasyon yok. Yeni bir istasyon oluÅŸturabilirsiniz.</p>
                        </div>
                    `;
                    this.updateSystemOverview([]);
                    return;
                }

                const controlsDisabled = this.canManageSimulator() ? '' : 'disabled';

                grid.innerHTML = stations.map((station) => {
                    const powerLabel = DashboardUtils.formatPower(station.config?.maxPower);
                    return `
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="card station-card ${station.isOnline ? 'online' : 'offline'}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${station.stationId}</h6>
                                    <span class="badge ${station.isOnline ? 'bg-success' : 'bg-danger'}">
                                        ${station.isOnline ? 'Online' : 'Offline'}
                                    </span>
                                </div>
                                <p class="card-text small text-muted">
                                    <strong>OCPP:</strong> ${station.config?.ocppVersion || 'N/A'}<br>
                                    <strong>Power:</strong> ${powerLabel}<br>
                                    <strong>Connectors:</strong> ${station.connectors?.length || 0}
                                </p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-success" ${controlsDisabled}
                                        onclick="dashboard.controlStation('${station.stationId}', 'start')">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" ${controlsDisabled}
                                        onclick="dashboard.controlStation('${station.stationId}', 'stop')">
                                        <i class="bi bi-stop"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" ${controlsDisabled}
                                        onclick="dashboard.controlStation('${station.stationId}', 'delete')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                this.updateSystemOverview(stations);
            }

            updateSystemOverview(stations) {
                const totalStations = stations.length;
                const onlineStations = stations.filter((s) => s.isOnline).length;
                const chargingSessions = stations.reduce((sum, s) => sum + (s.activeConnectors || 0), 0);
                const totalPower = stations.reduce((sum, s) => sum + (s.currentPower || 0), 0);

                document.getElementById('total-stations').textContent = totalStations;
                document.getElementById('online-stations').textContent = onlineStations;
                document.getElementById('charging-sessions').textContent = chargingSessions;
                document.getElementById('total-power').textContent = DashboardUtils.formatPower(totalPower);
            }

            async controlStation(stationId, action) {
                if (!this.canManageSimulator()) {
                    this.showToast('Yetki', 'Bu iÅŸlem iÃ§in izniniz yok.', 'warning');
                    return;
                }

                let url = '';
                let method = 'PUT';

                switch (action) {
                    case 'start':
                        url = `/api/simulator/stations/${stationId}/start`;
                        break;
                    case 'stop':
                        url = `/api/simulator/stations/${stationId}/stop`;
                        break;
                    case 'delete':
                        url = `/api/simulator/stations/${stationId}`;
                        method = 'DELETE';
                        break;
                    default:
                        this.showToast('Hata', 'GeÃ§ersiz iÅŸlem.', 'danger');
                        return;
                }

                try {
                    const response = await this.apiFetch(url, { method });
                    const data = await response.json();

                    if (data.success) {
                        this.showToast('BaÅŸarÄ±lÄ±', `Ä°stasyon ${action} iÅŸlemi tamamlandÄ±.`, 'success');
                        this.loadStations();
                    } else {
                        throw new Error(data.error || 'Ä°ÅŸlem baÅŸarÄ±sÄ±z.');
                    }
                } catch (error) {
                    if (error.message === 'Unauthorized' || error.message === 'Forbidden') {
                        return;
                    }
                    console.error(`Station ${action} error:`, error);
                    this.showToast('Hata', error.message || 'Ä°ÅŸlem gerÃ§ekleÅŸtirilemedi.', 'danger');
                }
            }

            async createStation(formData) {
                if (!this.canManageSimulator()) {
                    this.showToast('Yetki', 'Bu iÅŸlem iÃ§in izniniz yok.', 'warning');
                    return;
                }

                try {
                    const response = await this.apiFetch('/api/simulator/stations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.showToast('BaÅŸarÄ±lÄ±', 'Ä°stasyon oluÅŸturuldu.', 'success');
                        this.stationForm?.reset();
                        setTimeout(() => this.loadStations(), 500);
                    } else {
                        throw new Error(data.error?.message || data.error || 'Ä°stasyon oluÅŸturulamadÄ±.');
                    }
                } catch (error) {
                    if (error.message === 'Unauthorized' || error.message === 'Forbidden') {
                        return;
                    }
                    console.error('Create station error:', error);
                    this.showToast('Hata', error.message, 'danger');
                }
            }

            async startAllStations() {
                if (!this.canManageSimulator()) {
                    this.showToast('Yetki', 'TÃ¼m istasyonlarÄ± baÅŸlatmak iÃ§in yetkiniz yok.', 'warning');
                    return;
                }

                try {
                    const response = await this.apiFetch('/api/simulator/stations/start-all', { method: 'PUT' });
                    const data = await response.json();

                    if (data.success) {
                        this.showToast('BaÅŸarÄ±lÄ±', 'TÃ¼m istasyonlar baÅŸlatÄ±ldÄ±.', 'success');
                        this.loadStations();
                    }
                } catch (error) {
                    if (error.message === 'Unauthorized' || error.message === 'Forbidden') {
                        return;
                    }
                    this.showToast('Hata', 'Ä°stasyonlar baÅŸlatÄ±lamadÄ±.', 'danger');
                }
            }

            async stopAllStations() {
                if (!this.canManageSimulator()) {
                    this.showToast('Yetki', 'TÃ¼m istasyonlarÄ± durdurmak iÃ§in yetkiniz yok.', 'warning');
                    return;
                }

                try {
                    const response = await this.apiFetch('/api/simulator/stations/stop-all', { method: 'PUT' });
                    const data = await response.json();

                    if (data.success) {
                        this.showToast('BaÅŸarÄ±lÄ±', 'TÃ¼m istasyonlar durduruldu.', 'warning');
                        this.loadStations();
                    }
                } catch (error) {
                    if (error.message === 'Unauthorized' || error.message === 'Forbidden') {
                        return;
                    }
                    this.showToast('Hata', 'Ä°stasyonlar durdurulamadÄ±.', 'danger');
                }
            }

            async apiFetch(url, options = {}) {
                const fetchOptions = {
                    credentials: 'include',
                    ...options,
                };

                fetchOptions.headers = {
                    ...(options.headers || {}),
                };

                if (this.authEnabled && this.authToken && !fetchOptions.headers.Authorization) {
                    fetchOptions.headers.Authorization = `Bearer ${this.authToken}`;
                }

                const csrfToken = await this.ensureCsrfToken();
                if (csrfToken && !fetchOptions.headers['X-XSRF-TOKEN']) {
                    fetchOptions.headers['X-XSRF-TOKEN'] = csrfToken;
                }

                const startTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
                let retries = 0;

                try {
                    const response = await DashboardApi.fetchWithRetry(url, fetchOptions, {
                        retries: this.apiMaxRetries ?? DashboardApi.DEFAULT_MAX_RETRIES,
                        retryDelay: DashboardApi.DEFAULT_RETRY_DELAY,
                        retryOn: DashboardApi.RETRYABLE_STATUS,
                        onRetry: ({ attempt, response: retryResponse, error }) => {
                            retries = attempt + 1;
                            this.logRetryTelemetry('retry', {
                                url,
                                attempt: attempt + 1,
                                status: retryResponse?.status,
                                error: error?.message,
                            });
                        },
                    });

                    const duration = ((typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now()) - startTime;

                    if (response.status === 401) {
                        this.handleUnauthorized('Oturum sÃ¼reniz doldu, lÃ¼tfen tekrar giriÅŸ yapÄ±n.');
                        throw new Error('Unauthorized');
                    }

                    if (response.status === 403) {
                        this.showToast('Yetki', 'Bu iÅŸlem iÃ§in izniniz yok.', 'warning');
                        throw new Error('Forbidden');
                    }

                    if (!response.ok && response.status >= 500) {
                        throw new Error(`Server error (${response.status})`);
                    }

                    this.logRetryTelemetry('success', {
                        url,
                        status: response.status,
                        retries,
                        durationMs: Math.round(duration),
                    });

                    return response;
                } catch (error) {
                    const duration = ((typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now()) - startTime;
                    this.logRetryTelemetry('failure', {
                        url,
                        retries,
                        durationMs: Math.round(duration),
                        message: error?.message,
                    });
                    throw error;
                }
            }

            handleUnauthorized(message) {
                this.authenticated = false;
                this.currentUser = null;
                this.authToken = null;
                this.csrfToken = null;
                window.localStorage.removeItem('evsim_auth_token');
                document.cookie = 'XSRF-TOKEN=; Max-Age=0; path=/';

                if (this.ws) {
                    this.ws.disconnect();
                    this.ws = null;
                }

                this.updateAuthUI();
                this.setStationFormState(false);
                this.togglePermissionAlert(message);

                if (message) {
                    this.showToast('Oturum', message, 'warning');
                }

                if (this.loginModal) {
                    this.clearLoginFeedback();
                    this.loginModal.show();
                }
            }

            showToast(title, message, type = 'info') {
                const container = document.getElementById('toast-container');
                if (!container) {
                    return;
                }

                const toastHtml = `
                    <div class="toast align-items-center text-bg-${type} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                <strong>${title}:</strong> ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', toastHtml);
                const toastElement = container.lastElementChild;
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
                toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
            }

            logRetryTelemetry(event, details) {
                const payload = {
                    event,
                    timestamp: new Date().toISOString(),
                    ...details,
                };

                if (!window.__dashboardTelemetry) {
                    window.__dashboardTelemetry = [];
                }
                window.__dashboardTelemetry.push(payload);

                const logFn = event === 'failure' ? console.error : console.info;
                logFn('[DashboardTelemetry]', payload);
            }
        }

        let dashboard = null;

        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new EVSimulatorDashboard();

            window.loadStations = () => dashboard?.loadStations();
            window.refreshData = () => dashboard?.loadStations();
            window.startAllStations = () => dashboard?.startAllStations();
            window.stopAllStations = () => dashboard?.stopAllStations();
        });
    </script>
</body>

</html>
